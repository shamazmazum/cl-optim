<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>
  More examples &ndash; cl-optim
</title>
    <link rel="stylesheet" href="static/style.css"/>
    
  <link rel="stylesheet" href="static/highlight.css"/>
  <script src="static/highlight.js"></script>
  <script src="static/load-mathjax.js" async></script>
  <style>
   /* Highlight the current top-level TOC item, and hide the TOC of all other items */

   .toc a[data-node="more-examples"] {
       /*color: #AD3108;*/
   }

   .toc ol {
       display: none;
   }

   .toc li a[data-node="more-examples"] {
       font-weight: bold;
   }

   .toc li a[data-node="more-examples"] + ol {
       display: block;
   }

   .toc li a[data-node="more-examples"] + ol li {
       margin-left: 10px;
   }
  </style>

  </head>
  <body>
    
  <h1 class="doc-title">cl-optim</h1>
  <article id="article" data-section="more-examples">
    <aside>
      <ol class="toc"><li><a href="index.html" data-node="index">Manual</a><ol><li><a href="index.html#gradient-based-algorithms" data-node="gradient-based-algorithms">Gradient-based algorithms</a></li><li><a href="index.html#algorithms-which-work-without-gradient" data-node="algorithms-which-work-without-gradient">Algorithms which work without gradient</a></li><li><a href="index.html#linear-least-squares" data-node="linear-least-squares">Linear least squares</a></li></ol></li><li><a href="api.html" data-node="api">API</a></li><li><a href="tips.html" data-node="tips">Tips</a></li><li><a href="more-examples.html" data-node="more-examples">More examples</a><ol><li><a href="more-examples.html#solving-a-system-of-linear-equations" data-node="solving-a-system-of-linear-equations">Solving a system of linear equations</a></li></ol></li></ol>
    </aside>
    <main class="codex-section">
      <header>
        <h2 class="section-title">More examples</h2>
      </header>
      <div class="content">
        <p>   </p><h1 id="solving-a-system-of-linear-equations">Solving a system of linear equations</h1><p>      Consider this system of linear equations:
      </p><pre><code class=NIL> x + 2y +  z + 3w = 18
2x +  y +  z +  w = 12
 x + 3y + 2z + 4w = 28
 x + 5y + z  +  w = 23
      </code></pre><p>
      or \(Au = v\) in the matrix form where \(v\) is a column containing the
      right hand of the system and \(A\) is a 4x4 matrix containing coefficients
      on the left. The solution \(u\) minimizes the cost function \(\sum_k (Au -
      v_k)^2\). The code for the cost function is the following (requires
      <code>array-operations</code> library):
      </p><pre><code class="lisp">(defpackage linear-system
  (:use #:cl)
  (:local-nicknames (#:sera #:serapeum)
                    (#:diff #:cl-forward-diff))
  #.(cl-forward-diff:shadowing-import-math)
  (:export #:linear-system-cost #:%make-array))
(in-package :linear-system)

(sera:-&gt; matrix-vector-mul
         ((simple-array diff:dual (cl:* cl:*))
          (simple-array diff:dual (cl:*)))
         (values (simple-array diff:dual (cl:*)) &amp;optional))
(defun matrix-vector-mul (mat vec)
  &quot;Multiply a matrix MAT by a column VEC&quot;
  (aops:each-index* 'diff:dual i
      (aops:reduce-index #'+ j
          (* (aref mat i j)(aref vec j)))))

(sera:-&gt; linear-system-cost
         ((simple-array diff:dual (cl:* cl:*))
          (simple-array diff:dual (cl:*))
          (simple-array diff:dual (cl:*)))
         (values diff:dual &amp;optional))
(defun linear-system-cost (mat v u)
  &quot;Calculate a cost function for a system of linear equations MAT*X=V at the
  point X=U&quot;
  (let ((val (matrix-vector-mul mat u)))
    (reduce
     #'+ (map '(vector diff:dual)
              (lambda (v1 v2)
                (expt (- v1 v2) 2))
              v val))))

(defun %make-array (list shape)
  &quot;Helper function to convert lists to arrays of dual numbers&quot;
  (labels ((to-dual (list)
             (mapcar (lambda (x)
                       (if (listp x)(to-dual x)
                           (diff:make-dual (float x 0d0))))
                     list)))
    (make-array shape
                :element-type     'diff:dual
                :initial-contents (to-dual list))))
      </code></pre><p>      Now evaluate the following code in the REPL:
      </p><pre><code class="lisp">(cl-optim:bfgs/magicl
 (alexandria:curry #'linear-system:linear-system-cost
                   (linear-system:%make-array
                    '((1 2 1 3)
                      (2 1 1 1)
                      (1 3 2 4)
                      (1 5 1 1))
                    '(4 4))
                   (linear-system:%make-array
                    '(18 12 28 23)
                    '(4)))
 (magicl:zeros '(4)))
      </code></pre><p>      The answer is
      </p><pre><code class="lisp">#&lt;MAGICL:VECTOR/DOUBLE-FLOAT (4):
   1.000
   3.000
   5.000
   2.000&gt;
#&lt;MAGICL:MATRIX/DOUBLE-FLOAT (4x4):
  14.000    24.000    12.000    20.000
  24.000    77.993    28.000    48.002
  12.000    28.000    14.000    26.000
  20.000    48.002    26.000    53.998&gt;
7
      </code></pre><p>
      The first value is the minimizer of <code>linear-system-cost</code>: \((1, 3, 5,
      2)\). The second value is Hessian of the cost function at \(x\). The last
      value is a number of iterations needed to minimize the cost function.
   </p><p>
</p>
      </div>
    </main>
  </article>
  <footer>
    <div class="info">
      Created with <a href="https://github.com/CommonDoc/codex">Codex</a>.
    </div>
  </footer>
  <script>
   HighlightLisp.highlight_auto();
  </script>

  </body>
</html>
